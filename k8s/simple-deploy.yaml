# ç°¡æ˜“ç‰ˆGPUç›£è¦–ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ï¼‰

apiVersion: v1
kind: Namespace
metadata:
  name: gpu-monitoring
  labels:
    name: gpu-monitoring

---
# ç°¡æ˜“ç‰ˆWebUIï¼ˆGPUãªã—ã§ã‚‚å‹•ä½œï¼‰
apiVersion: v1
kind: ConfigMap
metadata:
  name: simple-gpu-monitor-ui
  namespace: gpu-monitoring
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GPUç›£è¦–ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆç°¡æ˜“ç‰ˆï¼‰</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                min-height: 100vh;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            .card {
                background: rgba(255, 255, 255, 0.9);
                color: #333;
                border-radius: 10px;
                padding: 20px;
                margin: 20px 0;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 5px;
            }
            .success { background: #d4edda; border: 1px solid #c3e6cb; }
            .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
            .error { background: #f8d7da; border: 1px solid #f5c6cb; }
            .metric {
                display: flex;
                justify-content: space-between;
                padding: 10px;
                margin: 5px 0;
                background: rgba(102, 126, 234, 0.1);
                border-radius: 5px;
            }
            button {
                background: #667eea;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 10px 5px;
            }
            button:hover {
                background: #5a67d8;
            }
            pre {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                overflow-x: auto;
                white-space: pre-wrap;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ–¥ï¸ GPUç›£è¦–ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h1>
            <p>ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</p>

            <div class="card">
                <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
                <div id="system-status">
                    <div class="status warning">
                        <strong>âš ï¸ è¨ºæ–­ä¸­...</strong><br>
                        ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚
                    </div>
                </div>
                <button onclick="checkSystem()">ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­</button>
                <button onclick="checkMetrics()">ğŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª</button>
                <button onclick="checkGPU()">ğŸ”§ GPUç¢ºèª</button>
            </div>

            <div class="card">
                <h3>ğŸ” è¨ºæ–­çµæœ</h3>
                <div id="diagnostic-results">
                    <p>ã€Œã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹</h3>
                <div id="metrics-list">
                    <p>ã€Œãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèªã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h3>
                <div class="status warning">
                    <strong>ä¸€èˆ¬çš„ãªå•é¡Œã¨è§£æ±ºæ–¹æ³•:</strong><br>
                    1. <strong>GPUã‚¢ãƒ‰ã‚ªãƒ³æœªæœ‰åŠ¹:</strong> <code>microk8s enable gpu</code><br>
                    2. <strong>ãƒãƒ¼ãƒ‰ãƒ©ãƒ™ãƒ«æœªè¨­å®š:</strong> <code>microk8s kubectl label nodes --all accelerator=nvidia</code><br>
                    3. <strong>NVIDIA ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:</strong> <code>nvidia-smi</code> ã§ç¢ºèª<br>
                    4. <strong>ãƒãƒƒãƒ‰èµ·å‹•å¤±æ•—:</strong> <code>microk8s kubectl describe pods -n gpu-monitoring</code>
                </div>
            </div>
        </div>

        <script>
            const prometheusUrl = '/api/prometheus';

            async function checkSystem() {
                const statusDiv = document.getElementById('system-status');
                const resultsDiv = document.getElementById('diagnostic-results');
                
                statusDiv.innerHTML = '<div class="status warning"><strong>ğŸ” è¨ºæ–­ä¸­...</strong></div>';
                
                let results = [];
                
                // Prometheusã®æ¥ç¶šç¢ºèª
                try {
                    const response = await fetch(`${prometheusUrl}/api/v1/query?query=up`);
                    if (response.ok) {
                        results.push('âœ… Prometheusæ¥ç¶š: æ­£å¸¸');
                        statusDiv.innerHTML = '<div class="status success"><strong>âœ… Prometheusæ¥ç¶šæ­£å¸¸</strong></div>';
                    } else {
                        results.push('âŒ Prometheusæ¥ç¶š: å¤±æ•—');
                        statusDiv.innerHTML = '<div class="status error"><strong>âŒ Prometheusæ¥ç¶šå¤±æ•—</strong></div>';
                    }
                } catch (error) {
                    results.push('âŒ Prometheusæ¥ç¶š: ã‚¨ãƒ©ãƒ¼ - ' + error.message);
                    statusDiv.innerHTML = '<div class="status error"><strong>âŒ Prometheusæ¥ç¶šã‚¨ãƒ©ãƒ¼</strong></div>';
                }

                // DCGM Exporterã®ç¢ºèª
                try {
                    const response = await fetch(`${prometheusUrl}/api/v1/query?query=up{job="dcgm-exporter"}`);
                    const data = await response.json();
                    if (data.data && data.data.result && data.data.result.length > 0) {
                        results.push('âœ… DCGM Exporter: å‹•ä½œä¸­');
                    } else {
                        results.push('âŒ DCGM Exporter: æœªæ¤œå‡º');
                    }
                } catch (error) {
                    results.push('âŒ DCGM Exporter: ç¢ºèªã‚¨ãƒ©ãƒ¼');
                }

                resultsDiv.innerHTML = '<pre>' + results.join('\n') + '</pre>';
            }

            async function checkMetrics() {
                const metricsDiv = document.getElementById('metrics-list');
                metricsDiv.innerHTML = '<p>ğŸ” ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç¢ºèªä¸­...</p>';

                try {
                    const response = await fetch(`${prometheusUrl}/api/v1/label/__name__/values`);
                    const data = await response.json();
                    
                    if (data.data) {
                        const dcgmMetrics = data.data.filter(m => m.includes('DCGM') || m.includes('dcgm'));
                        const gpuMetrics = data.data.filter(m => m.toLowerCase().includes('gpu'));
                        
                        let output = '<h4>ğŸ“Š DCGMé–¢é€£ãƒ¡ãƒˆãƒªã‚¯ã‚¹ (' + dcgmMetrics.length + 'å€‹):</h4>';
                        if (dcgmMetrics.length > 0) {
                            output += '<pre>' + dcgmMetrics.join('\n') + '</pre>';
                        } else {
                            output += '<p class="status error">âŒ DCGMãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                        }
                        
                        output += '<h4>ğŸ”§ GPUé–¢é€£ãƒ¡ãƒˆãƒªã‚¯ã‚¹ (' + gpuMetrics.length + 'å€‹):</h4>';
                        if (gpuMetrics.length > 0) {
                            output += '<pre>' + gpuMetrics.slice(0, 20).join('\n');
                            if (gpuMetrics.length > 20) output += '\n... (' + (gpuMetrics.length - 20) + 'å€‹çœç•¥)';
                            output += '</pre>';
                        } else {
                            output += '<p class="status error">âŒ GPUãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                        }
                        
                        metricsDiv.innerHTML = output;
                    } else {
                        metricsDiv.innerHTML = '<p class="status error">âŒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                    }
                } catch (error) {
                    metricsDiv.innerHTML = '<p class="status error">âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
                }
            }

            async function checkGPU() {
                const resultsDiv = document.getElementById('diagnostic-results');
                
                try {
                    // GPUä½¿ç”¨ç‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç¢ºèª
                    const queries = [
                        'DCGM_FI_DEV_GPU_UTIL',
                        'dcgm_gpu_utilization',
                        'DCGM_FI_DEV_FB_TOTAL',
                        'dcgm_fb_total'
                    ];
                    
                    let results = ['ğŸ”§ GPU ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèªçµæœ:'];
                    
                    for (const query of queries) {
                        try {
                            const response = await fetch(`${prometheusUrl}/api/v1/query?query=${encodeURIComponent(query)}`);
                            const data = await response.json();
                            
                            if (data.data && data.data.result && data.data.result.length > 0) {
                                results.push(`âœ… ${query}: ${data.data.result.length}å€‹ã®ã‚µãƒ³ãƒ—ãƒ«`);
                                
                                // æœ€åˆã®ã‚µãƒ³ãƒ—ãƒ«ã®è©³ç´°ã‚’è¡¨ç¤º
                                const sample = data.data.result[0];
                                results.push(`   ãƒãƒ¼ãƒ‰: ${sample.metric.node || sample.metric.instance || 'unknown'}`);
                                results.push(`   GPU: ${sample.metric.gpu || sample.metric.GPU || sample.metric.device || 'unknown'}`);
                                results.push(`   å€¤: ${sample.value[1]}`);
                            } else {
                                results.push(`âŒ ${query}: ãƒ‡ãƒ¼ã‚¿ãªã—`);
                            }
                        } catch (error) {
                            results.push(`âŒ ${query}: ã‚¨ãƒ©ãƒ¼`);
                        }
                    }
                    
                    resultsDiv.innerHTML = '<pre>' + results.join('\n') + '</pre>';
                } catch (error) {
                    resultsDiv.innerHTML = '<p class="status error">âŒ GPUç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
                }
            }

            // è‡ªå‹•è¨ºæ–­é–‹å§‹
            window.addEventListener('load', () => {
                setTimeout(checkSystem, 1000);
            });
        </script>
    </body>
    </html>

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: simple-gpu-monitor-ui
  namespace: gpu-monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: simple-gpu-monitor-ui
  template:
    metadata:
      labels:
        app: simple-gpu-monitor-ui
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: ui-config
          mountPath: /usr/share/nginx/html
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi
      volumes:
      - name: ui-config
        configMap:
          name: simple-gpu-monitor-ui
      - name: nginx-config
        configMap:
          name: simple-nginx-config

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: simple-nginx-config
  namespace: gpu-monitoring
data:
  default.conf: |
    server {
        listen 80;
        server_name localhost;
        
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        location /api/prometheus/ {
            proxy_pass http://prometheus:9090/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }

---
apiVersion: v1
kind: Service
metadata:
  name: simple-gpu-monitor-ui
  namespace: gpu-monitoring
spec:
  selector:
    app: simple-gpu-monitor-ui
  type: NodePort
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30090
      protocol: TCP
      name: http